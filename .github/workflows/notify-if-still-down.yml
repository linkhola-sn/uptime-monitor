name: Notify if Still Down

on:
  workflow_run:
    workflows: ["Uptime CI"]
    types:
      - completed
  workflow_dispatch: # â† ã“ã‚Œã‚’è¿½åŠ ã™ã‚‹ã¨ã€ŒRun workflowã€ãƒœã‚¿ãƒ³ã§æ‰‹å‹•å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™

jobs:
  notify-down:
    runs-on: ubuntu-latest
    # æ‰‹å‹•å®Ÿè¡Œ(workflow_dispatch)ã®å ´åˆã¯å¸¸ã«å®Ÿè¡Œã€è‡ªå‹•å®Ÿè¡Œã®å ´åˆã¯æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master # ã¾ãŸã¯ main (ãƒªãƒã‚¸ãƒˆãƒªã®è¨­å®šã«åˆã‚ã›ã¦ãã ã•ã„)

      - name: Debug File List
        run: ls -la # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¦READMEãŒã‚ã‚‹ã‹ç¢ºèª

      - name: Check for Down status and Notify
        env:
          WEBHOOK_URL: ${{ secrets.NOTIFICATION_URL }}
        run: |
          if grep -q "Down" README.md; then
            echo "ğŸš¨ Down sites detected."
            curl -X POST -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âš ï¸ [ç¶™ç¶šé€šçŸ¥] ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆãŒã¾ã ãƒ€ã‚¦ãƒ³ã—ã¦ã„ã¾ã™ã€‚\n\nè©³ç´°ç¢ºèª: https://github.com/${{ github.repository }}"
              }
            }' \
            $WEBHOOK_URL
          else
            echo "âœ… All sites are up or README not found."
          fi
