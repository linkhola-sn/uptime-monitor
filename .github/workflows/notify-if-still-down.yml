name: Notify if Still Down

on:
  workflow_run:
    workflows: ["Uptime CI"]
    types:
      - completed

jobs:
  notify-down:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }} # CIè‡ªä½“ã¯æˆåŠŸ(å®Œäº†)ã—ã¦ã„ã‚‹å ´åˆ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Down status and Notify
        env:
          # ã“ã“ã«ã¯ã€Œhttps://...ã€ã‹ã‚‰å§‹ã¾ã‚‹Webhook URLãŒå…¥ã£ã¦ã„ã‚‹Secretã‚’æŒ‡å®šã—ã¦ãã ã•ã„
          # æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½œã£ãŸåå‰ãŒ LARK_WEBHOOK_URL ã§ã‚ã‚Œã°ãã®ã¾ã¾ã§OK
          WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        run: |
          # README.md ã®ä¸­ã« " is :red_circle: down" ã®ã‚ˆã†ãªè¡¨è¨˜ãŒã‚ã‚‹ã‹æ¢ã™
          # Upptimeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã‚Šè¡¨è¨˜ãŒç•°ãªã‚‹ãŸã‚ã€å˜ç´”ã« "Down" ã¨ã„ã†å˜èªã§æ¤œçŸ¥
          if grep -q "Down" README.md; then
            echo "ğŸš¨ Down sites detected. Sending notification..."
            
            curl -X POST -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âš ï¸ [ç¶™ç¶šé€šçŸ¥] ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆãŒã¾ã ãƒ€ã‚¦ãƒ³ã—ã¦ã„ã¾ã™ã€‚\n\nè©³ç´°ç¢ºèª: https://github.com/${{ github.repository }}"
              }
            }' \
            $WEBHOOK_URL
          else
            echo "âœ… All sites are up. No notification needed."
          fi
