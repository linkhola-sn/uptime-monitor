name: Daily Lark Notification

on:
  schedule:
    # æ¯æ—¥ UTC 21:00 (= æ—¥æœ¬æ™‚é–“ ç¿Œ06:00) ã«é€šçŸ¥
    - cron: "0 21 * * *"
  workflow_dispatch:

jobs:
  notify-daily:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send daily status to Lark
        env:
          WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          python - <<'PY' > /tmp/lark-payload.json
          import json
          import os
          from datetime import datetime
          from pathlib import Path
          from zoneinfo import ZoneInfo

          data = json.loads(Path("history/summary.json").read_text(encoding="utf-8"))
          total = len(data)
          down = [item["name"] for item in data if item.get("status") == "down"]
          down_count = len(down)

          date_str = datetime.now(ZoneInfo("Asia/Tokyo")).strftime("%Y-%m-%d")
          if down_count:
              status_line = f"âš ï¸ Down {down_count}/{total}: " + ", ".join(down)
          else:
              status_line = f"âœ… All sites up ({total}/{total})"

          text = (
              f"ğŸŒ… [Upptime] æ¯æœã‚µãƒãƒªãƒ¼ {date_str}\n"
              f"{status_line}\n"
              f"è©³ç´°: https://github.com/{os.environ['GITHUB_REPOSITORY']}"
          )
          payload = {"msg_type": "text", "content": {"text": text}}
          print(json.dumps(payload, ensure_ascii=False))
          PY
          curl -sS -X POST -H "Content-Type: application/json" -d @/tmp/lark-payload.json "$WEBHOOK_URL"
