name: Notify if Still Down

on:
  workflow_run:
    workflows: ["Uptime CI"]
    types:
      - completed

jobs:
  notify-down:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master # é‡è¦: UpptimeãŒæ›´æ–°ã—ã¦ã„ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®š

      - name: Check for Down status and Notify
        env:
          WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        run: |
          # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¦ã¿ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼åŸå› ã®åˆ‡ã‚Šåˆ†ã‘ç”¨ï¼‰
          ls -la

          if grep -q "Down" README.md; then
            echo "ğŸš¨ Down sites detected. Sending notification..."
            curl -X POST -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âš ï¸ [ç¶™ç¶šé€šçŸ¥] ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆãŒã¾ã ãƒ€ã‚¦ãƒ³ã—ã¦ã„ã¾ã™ã€‚\n\nè©³ç´°ç¢ºèª: https://github.com/${{ github.repository }}"
              }
            }' \
            $WEBHOOK_URL
          else
            echo "âœ… All sites are up. No notification needed."
          fi
