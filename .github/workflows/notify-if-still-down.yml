name: Notify if Still Down

on:
  schedule:
    # æ¯æ—¥ UTC 21:00 (= æ—¥æœ¬æ™‚é–“ ç¿Œ06:00) ã«é€šçŸ¥ãƒã‚§ãƒƒã‚¯
    - cron: "0 21 * * *"
  workflow_dispatch:

    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    steps:

jobs:
  notify-down:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master # ã¾ãŸã¯ main

      - name: Check for Down status and Notify
        env:
          WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        run: |
          # å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã›ãš(-i) Downã‚’æ¢ã™
          if grep -i -q "Down" README.md; then
            echo "ğŸš¨ Down sites detected. Sending notification..."
            
            # ã€é‡è¦ã€‘Larkã®è¨­å®šã«åˆã‚ã›ã¦ 'Upptime' ã¨ 'Down' (è‹±èª) ã‚’å«ã‚ã¾ã™
            curl -X POST -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âš ï¸ [Upptime Alert] ç¶™ç¶šé€šçŸ¥\n\nã„ãã¤ã‹ã®ã‚µã‚¤ãƒˆãŒç¾åœ¨ã‚‚ Down ã—ã¦ã„ã¾ã™ã€‚\n\nè©³ç´°ç¢ºèª: https://github.com/${{ github.repository }}"
              }
            }' \
            $WEBHOOK_URL
          else
            echo "âœ… All sites are up. No notification needed."
          fi
